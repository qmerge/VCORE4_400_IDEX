#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: True
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: run BEACON_RATOS_CALIBRATE to automatically calibrate your beacon for scan and contact.
###    IMPORTANT: Ensure the beacon is properly mounted and the nozzle and meltzone is clean by unloading
###    the filament (if it's loaded) and make sure there's no ooze or gunk on the nozzle when the hotend is at printing temperature.
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################
[printer]
max_velocity: 600
max_accel: 3000
#minimum_cruise_ratio: 0.5
#max_z_velocity: 50
#max_z_accel: 600
#square_corner_velocity: 5

[gcode_macro RatOS]
variable_shaper_x_freq: [44, 44, 44, 44]                                   # shaper frequency [T0, T1, COPY, MIRROR]
variable_shaper_y_freq: [51, 51, 51, 51]                                   # shaper frequency [T0, T1, COPY, MIRROR]
#variable_shaper_x_type: ["mzv", "mzv", "mzv", "mzv"]                   # shaper frequency algorythm [T0, T1, COPY, MIRROR]
variable_shaper_x_type: ["ei", "ei", "ei", "ei"]                   # shaper frequency algorythm [T0, T1, COPY, MIRROR]
variable_shaper_y_type: ["2hump_ei", "2hump_ei", "2hump_ei", "2hump_ei"]                   # shaper frequency algorythm [T0, T1, COPY, MIRROR]

[ratos]
allow_unsupported_slicer_versions: True

[led sidelights]
white_pin: mcu:PB11
hardware_pwm: True
initial_WHITE: 0.5

###https://os.ratrig.com/docs/configuration/filament_sensors/
###https://gadgetangel.org/build/electrical/images/BIGTREETECH-Octopus-1.1-color-PIN_compress.jpg
[filament_switch_sensor bowden_filament_sensor_t0]
pause_on_runout: False
event_delay: 0.1
switch_pin: ^PG14
runout_gcode:
    _ON_BOWDEN_FILAMENT_SENSOR_RUNOUT TOOLHEAD=0
insert_gcode:
    _ON_BOWDEN_FILAMENT_SENSOR_INSERT TOOLHEAD=0
[filament_switch_sensor bowden_filament_sensor_t1]
pause_on_runout: False
event_delay: 0.1
switch_pin: ^PG13
runout_gcode:
    _ON_BOWDEN_FILAMENT_SENSOR_RUNOUT TOOLHEAD=1
insert_gcode:
    _ON_BOWDEN_FILAMENT_SENSOR_INSERT TOOLHEAD=1

#SET_FAN_SPEED FAN=enclosure_heater SPEED=255
[controller_fan enclosure_heater]
pin: PD15
max_power: 1.0
shutdown_speed: 0.0
heater: heater_bed, extruder

[extruder]
pressure_advance: 0.04

[extruder1]
pressure_advance: 0.04

[heater_bed]
max_power: 0.7

[tmc2209 stepper_x]
run_current: 1.6

[tmc2209 stepper_y]
run_current: 1.6

[tmc2209 stepper_y1]
run_current: 1.6

[tmc2209 dual_carriage]
run_current: 1.6

#---------------------------------------------------- X -----------------------------------------------------
# The X axis motor for the left toolhead, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------

#---------------------------------------------------- X -----------------------------------------------------
# The X axis motor for the left toolhead, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin                # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -59.8
position_max: 400
position_endstop: -59.8

#---------------------------------------------- DUAL_CARRIAGE -----------------------------------------------
# The X axis motor for the right toolhead, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[dual_carriage]
dir_pin: dual_carriage_dir_pin    # Add ! in front of pin name to reverse the direction of dual_carriage
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
position_min: 0
position_max: 459.8
position_endstop: 459.8
safe_distance: 55

#---------------------------------------------------- Y -----------------------------------------------------
# The left Y motor used for cartesian Y control in Hybrid CoreXY, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -14.35
position_max: 433.65
position_endstop: -14.35

#---------------------------------------------------- Y1 ----------------------------------------------------
# The right Y motor used for cartesian Y control in Hybrid CoreXY, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y1]
dir_pin: y1_dir_pin               # Add ! in front of pin name to reverse the direction of stepper_y1
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4              # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -7
position_max: 400

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4              # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4              # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the left toolhead (T0)
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: toolboard_t0:e_dir_pin   # Add ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.63           # Orbiter 2 default
#pressure_advance: 0.05           # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300

#------------------------------------------------ EXTRUDER1 -------------------------------------------------
# The extruder motor used for pushing filament through the right toolhead (T1)
#------------------------------------------------------------------------------------------------------------
[extruder1]
dir_pin: toolboard_t1:e_dir_pin   # Add ! in front of pin name to reverse the direction of extruder1
rotation_distance: 4.63           # Orbiter 2 default
#pressure_advance: 0.05           # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300


[heater_bed]
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

[z_offset_probe]
pin: ^PG10                   # probe trigger pin    
z_offset: -7                   # probe height, used to limit the probe z-move
y_offset: 0                    # probe y-offset, measured from the camera centre
x_offset: 37.5               # probe x-offset, measured from the camera centre
speed: 10                      
samples: 3                    # number of samples  
sample_retract_dist: 5
lift_speed: 10.0
samples_result: median
samples_tolerance: 0.2
samples_tolerance_retries: 5
[neopixel vaoc_led]
pin: PB0
chain_count: 6
color_order: GRB
[heater_fan vaoc_fan]
pin: PD13
heater: heater_bed
fan_speed: 1.0
heater_temp: 50

[dual_carriage]
position_max: 459.771
position_endstop: 459.771

[gcode_macro RatOS]
variable_bed_margin_x: [59.800, 59.771]

[gcode_macro _VAOC]
variable_expected_camera_x_position: 164.252
variable_expected_camera_y_position: 428.268

[gcode_macro T0]
variable_parking_position: -57.800

[gcode_macro T1]
variable_parking_position: 457.771

# REMEMBER TO CALIBRATE YOUR BEACON!
# Run BEACON_RATOS_CALIBRATE for automatic calibration.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 38.849
#*# pid_ki = 10.360
#*# pid_kd = 36.421
#*#
#*# [extruder1]
#*# control = pid
#*# pid_kp = 36.469
#*# pid_ki = 9.005
#*# pid_kd = 36.925
#*#
#*# [beacon model default]
#*# model_coef = 1.5405291759799566,
#*# 	  1.9033847235994759,
#*# 	  0.761642679206183,
#*# 	  0.20324293959827056,
#*# 	  0.22907079365596372,
#*# 	  0.4766899818476658,
#*# 	  -0.07985973690416845,
#*# 	  -0.4141918678134641,
#*# 	  0.14840970078051274,
#*# 	  0.23327926862109324
#*# model_domain = 1.853131000382308e-07,1.9376251209404571e-07
#*# model_range = 0.199896,4.999896
#*# model_temp = 46.150023
#*# model_offset = 0.00000
#*#
#*# [heater_bed]
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  0.057264, 0.051728, 0.044647, 0.042922, 0.045452, 0.047798, 0.049761, 0.048439, 0.050308, 0.056736, 0.059124, 0.057464, 0.053783, 0.053555, 0.052171, 0.055319, 0.058960
#*# 	  0.055901, 0.059072, 0.051613, 0.048108, 0.051155, 0.053281, 0.052011, 0.050167, 0.052793, 0.057657, 0.061874, 0.059395, 0.057932, 0.055656, 0.052979, 0.056761, 0.059837
#*# 	  0.043737, 0.051351, 0.052031, 0.047739, 0.049324, 0.052270, 0.052430, 0.052153, 0.055522, 0.061769, 0.067362, 0.069239, 0.066470, 0.064496, 0.061389, 0.060852, 0.062665
#*# 	  0.034885, 0.041303, 0.041536, 0.041189, 0.045206, 0.046189, 0.047375, 0.051749, 0.057173, 0.065728, 0.068512, 0.068779, 0.069125, 0.068642, 0.066467, 0.067398, 0.068731
#*# 	  0.023927, 0.024917, 0.026527, 0.028141, 0.030020, 0.032913, 0.035754, 0.039006, 0.043826, 0.051751, 0.055106, 0.056323, 0.058450, 0.058069, 0.059592, 0.059212, 0.062150
#*# 	  0.051461, 0.054119, 0.054485, 0.054500, 0.056840, 0.059843, 0.061028, 0.064278, 0.067161, 0.071832, 0.072449, 0.073925, 0.078656, 0.079278, 0.079118, 0.080382, 0.080741
#*# 	  0.044424, 0.045326, 0.043990, 0.042816, 0.045293, 0.047254, 0.052285, 0.054208, 0.056662, 0.059102, 0.062454, 0.066056, 0.069772, 0.072611, 0.072169, 0.069946, 0.073882
#*# 	  0.034864, 0.038255, 0.036633, 0.037617, 0.038388, 0.044186, 0.049456, 0.052104, 0.054936, 0.059720, 0.061942, 0.062929, 0.068576, 0.070049, 0.067850, 0.071011, 0.075322
#*# 	  0.018455, 0.019989, 0.024034, 0.025635, 0.029100, 0.035206, 0.042836, 0.045331, 0.051113, 0.056684, 0.057574, 0.059473, 0.061450, 0.062969, 0.064833, 0.067626, 0.073129
#*# 	  0.019694, 0.025555, 0.026639, 0.028405, 0.032356, 0.037721, 0.043442, 0.048680, 0.053473, 0.057343, 0.057476, 0.058646, 0.062587, 0.064918, 0.068083, 0.072155, 0.079301
#*# 	  0.006835, 0.010582, 0.011981, 0.016108, 0.021672, 0.026535, 0.032454, 0.036695, 0.041593, 0.044738, 0.046334, 0.047763, 0.051671, 0.055335, 0.058599, 0.062349, 0.069952
#*# 	  0.000462, 0.006311, 0.009431, 0.015053, 0.019019, 0.023344, 0.029312, 0.033019, 0.038002, 0.041709, 0.043902, 0.047237, 0.052013, 0.055033, 0.058743, 0.064306, 0.069734
#*# 	  -0.000625, 0.002830, 0.009872, 0.014540, 0.020298, 0.024767, 0.027766, 0.031119, 0.038840, 0.040715, 0.042912, 0.045851, 0.048574, 0.050909, 0.056088, 0.058897, 0.065263
#*# 	  0.016567, 0.023066, 0.024779, 0.028015, 0.031590, 0.035308, 0.039096, 0.047597, 0.052902, 0.055109, 0.058536, 0.059125, 0.061439, 0.063658, 0.067359, 0.074070, 0.079613
#*# 	  0.021379, 0.028387, 0.032073, 0.037179, 0.041318, 0.042472, 0.050970, 0.057120, 0.062120, 0.069044, 0.073207, 0.073265, 0.075417, 0.078963, 0.082178, 0.087713, 0.095425
#*# 	  0.030725, 0.035191, 0.039853, 0.045755, 0.047052, 0.049021, 0.060763, 0.064216, 0.067321, 0.071406, 0.074168, 0.074646, 0.077046, 0.077918, 0.082764, 0.091553, 0.097640
#*# 	  0.028612, 0.033611, 0.037299, 0.041859, 0.051071, 0.053841, 0.063127, 0.067700, 0.065125, 0.069346, 0.074006, 0.076188, 0.077358, 0.079152, 0.084730, 0.090361, 0.100526
#*# 	  0.041156, 0.046976, 0.048091, 0.052898, 0.062478, 0.071853, 0.079907, 0.085927, 0.082153, 0.085039, 0.092093, 0.092244, 0.094296, 0.096141, 0.099773, 0.107958, 0.115639
#*# 	  0.031897, 0.038028, 0.039543, 0.043576, 0.053078, 0.065996, 0.075460, 0.086369, 0.086612, 0.086861, 0.090058, 0.093820, 0.095119, 0.097860, 0.101865, 0.107274, 0.117144
#*# 	  0.028225, 0.031124, 0.035631, 0.043567, 0.049106, 0.062071, 0.074487, 0.087206, 0.094720, 0.092442, 0.093115, 0.096055, 0.099662, 0.100535, 0.103383, 0.111095, 0.118666
#*# 	  0.019550, 0.021526, 0.026711, 0.034607, 0.042959, 0.046753, 0.061547, 0.077606, 0.090120, 0.095462, 0.090290, 0.090843, 0.092749, 0.093043, 0.097645, 0.099626, 0.109418
#*# 	  0.014850, 0.017362, 0.025618, 0.032808, 0.037886, 0.043767, 0.053767, 0.068789, 0.084110, 0.090138, 0.086398, 0.084285, 0.086373, 0.087109, 0.094471, 0.096729, 0.101033
#*# 	  0.006329, 0.012257, 0.017386, 0.026121, 0.032484, 0.036226, 0.044838, 0.056122, 0.070198, 0.082894, 0.086138, 0.083169, 0.084725, 0.087769, 0.097644, 0.101438, 0.103062
#*# 	  0.016256, 0.020039, 0.024317, 0.032240, 0.036142, 0.042483, 0.049298, 0.059646, 0.072384, 0.088030, 0.094687, 0.094644, 0.097103, 0.099767, 0.109007, 0.113279, 0.114518
#*# 	  0.017217, 0.020277, 0.019920, 0.022270, 0.029150, 0.034820, 0.041788, 0.051331, 0.062953, 0.074604, 0.087918, 0.096885, 0.101294, 0.106513, 0.112803, 0.114791, 0.122936
#*# 	  0.019948, 0.020447, 0.021758, 0.025546, 0.030713, 0.038287, 0.046956, 0.055000, 0.065015, 0.074883, 0.086429, 0.102034, 0.111432, 0.114954, 0.117768, 0.125218, 0.132886
#*# 	  0.028020, 0.028529, 0.027419, 0.032309, 0.038541, 0.046710, 0.053643, 0.062949, 0.070114, 0.078124, 0.087842, 0.101689, 0.111426, 0.118675, 0.124557, 0.129205, 0.140405
#*# x_count = 17
#*# y_count = 27
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 110.158
#*# max_x = 318.394
#*# min_y = 50.2006
#*# max_y = 351.226
